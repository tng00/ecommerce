{% extends "base.html" %}

{% block title %}Товары{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/catalog.css">
<h2>Все товары</h2>



<script>
    function checkMax(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
        const max = parseInt(input.max, 10); 
        const value = parseInt(input.value, 10); 

        if (value > max) {
            input.value = max;
        }

        if (value < 0) {
            input.value = 0;
        }
    }

    function addToCart(productId, price) {
        const quantityInput = document.getElementById('quantity_' + productId);
        const quantity = parseInt(quantityInput.value, 10);

        if (quantity < 1) {
            alert('Количество должно быть не менее 1.');
            return;
        }

        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Товар добавлен в корзину.');
            } else {
                alert(data.message || 'Не удалось добавить товар в корзину.');
            }
        })
        .catch(error => {
            console.error('Ошибка при добавлении товара в корзину:', error);
        });
    }

    function submitOrder(paymentMethod) {
    const address = document.getElementById('address').value;
    const orderItems = [];
    let total = 0;

    const productCards = document.querySelectorAll('.product-card');

    productCards.forEach(card => {
        const id = card.querySelector('.product-link').href.split('/').pop();
        const price = parseFloat(card.querySelector('.product-price').textContent.replace('₽', '').trim());
        const quantityInput = card.querySelector('input[type="number"]');
        const quantity = parseInt(quantityInput.value, 10) || 0;

        if (quantity > 0) {
            orderItems.push({
                product_id: id,
                quantity: quantity,
                price: price
            });
            total += price * quantity;
        }
    });

    if (address.trim() === '') {
        alert('Пожалуйста, введите адрес.');
        return;
    }

    if (orderItems.length === 0) {
        alert('Пожалуйста, выберите хотя бы один товар.');
        return;
    }

    fetch('/order/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            address: address,
            is_card: paymentMethod === 'is_card',
            is_sbp: paymentMethod === 'is_sbp',
            items: orderItems,
            total: total
        }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.check_url) {
                window.open(data.check_url, '_blank');
            } else {
                alert('Заказ успешно создан!');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при создании заказа.');
        });
}


</script>

{% endblock %}