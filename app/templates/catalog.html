{% extends "base.html" %}

{% block title %}Товары{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/catalog.css">
<h2>Все товары</h2>

<div>
    <label for="address">Введите адрес:</label>
    <input class="addr"type="text" id="address" name="address" required>
</div>

<div>
    <button id="pay_card" onclick="submitOrder('is_card')">Оплатить картой</button>
    <button id="pay_sbp" onclick="submitOrder('is_sbp')">Оплатить по СБП</button>
</div>

<div class="product-grid">
    {% for product in products %}
    {% if product.is_active %} 
    <div class="product-card">
        <a href="/product/{{ product.id }}" class="product-link">
            <div class="product-image">
                <img src="{{ product.image_url }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="product-info">
                <h3 class="product-title">{{ product.name }}</h3>
                <p class="product-price">{{ product.price }} ₽</p>
                <p class="product-manufacturer">{{ product.manufacturer }}</p>
                <div class="product-rating">
                    <span class="rating-stars">⭐</span>
                    <span class="rating-count">{{ product.rating | round(1) }}</span>
                </div>
            </div>
        </a>
        <div class="quantity-input">
            <input type="number" id="quantity_{{ product.id }}" name="quantity_{{ product.id }}" min="0"
            max="{{ product.stock }}" value="0" oninput="checkMax(this)">
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<script>
    function checkMax(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
        const max = parseInt(input.max, 10); 
        const value = parseInt(input.value, 10); 

        if (value > max) {
            input.value = max;
        }

        if (value < 0) {
            input.value = 0;
        }
    }

    function submitOrder(paymentMethod) {
    const address = document.getElementById('address').value;
    const orderItems = [];
    let total = 0;

    const productCards = document.querySelectorAll('.product-card');

    productCards.forEach(card => {
        const id = card.querySelector('.product-link').href.split('/').pop();
        const price = parseFloat(card.querySelector('.product-price').textContent.replace('₽', '').trim());
        const quantityInput = card.querySelector('input[type="number"]');
        const quantity = parseInt(quantityInput.value, 10) || 0;

        if (quantity > 0) {
            orderItems.push({
                product_id: id,
                quantity: quantity,
                price: price
            });
            total += price * quantity;
        }
    });

    if (address.trim() === '') {
        alert('Пожалуйста, введите адрес.');
        return;
    }

    if (orderItems.length === 0) {
        alert('Пожалуйста, выберите хотя бы один товар.');
        return;
    }

    fetch('/order/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            address: address,
            is_card: paymentMethod === 'is_card',
            is_sbp: paymentMethod === 'is_sbp',
            items: orderItems,
            total: total
        }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.check_url) {
                window.open(data.check_url, '_blank');
            } else {
                alert('Заказ успешно создан!');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при создании заказа.');
        });
}


</script>

{% endblock %}