<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Корзина</h1>

        <!-- User Information -->
        <div class="mb-3">
            <h4>Привет, {{ user['username'] }}</h4>
        </div>

        <!-- Cart Table -->
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Продукт</th>
                    <th>Описание</th>
                    <th>Цена</th>
                    <th>Доступно</th>
                    <th>Количество</th>
                    <th>Итоговая стоимость</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% if cart_items %}
                {% for item in cart_items %}
                <tr data-product-id="{{ item.product_id }}">
                    <td>{{ item.name }}</td>
                    <td>{{ item.description }}</td>
                    <td>{{ item.price }} ₽</td>
                    <td>{{ item.stock }}</td>
                    <td>
                        <input type="number" id="quantity-{{ item.product_id }}" value="{{ item.quantity }}" min="1"
                            max="{{ item.stock }}" class="form-control"
                            onchange="updateCartItem({{ item.product_id }}, this.value)">
                    </td>
                    <td>{{ item.total_cost }} ₽</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeCartItem({{ item.product_id }})">
                            Удалить
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="text-center">Ваша корзина пуста.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Total Cost -->
        <div class="mt-4">
            <h5 id="total-cost">Общая стоимость: {{ total_cost }} ₽</h5>
        </div>

        <!-- Address Input -->
        <div id="payment-options" class="mt-4">
            <h5>Введите адрес доставки:</h5>
            <div class="mb-3">
                <input type="text" id="address" class="form-control" placeholder="Введите адрес" required>
            </div>

            <!-- Payment Options -->
            <h5>Выберите способ оплаты:</h5>
            <div class="d-flex">
                <button onclick="submitOrder(true)" class="btn btn-primary me-2">Оплатить картой</button>
                <button onclick="submitOrder(false)" class="btn btn-success">Оплатить через СБП</button>
            </div>
        </div>

        <!-- Actions -->


    </div>

    <script>

        document.addEventListener('DOMContentLoaded', () => {
            togglePaymentOptions();
        });

        function togglePaymentOptions() {
            const totalCostElement = document.getElementById('total-cost');
            const paymentOptions = document.getElementById('payment-options');

            if (totalCostElement) {
                // Извлекаем сумму из текста (например, "Общая стоимость: 0 ₽")
                const totalCost = parseInt(totalCostElement.textContent.replace(/[^\d]/g, ''), 10);

                if (totalCost === 0) {
                    // Скрыть блок с кнопками оплаты
                    paymentOptions.style.display = 'none';
                } else {
                    // Показать блок с кнопками оплаты
                    paymentOptions.style.display = 'block';
                }
            }
        }

        async function updateCartItem(productId, quantity) {
            try {
                const response = await fetch(`/cart/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ [productId]: parseInt(quantity) }),
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Корзина обновлена!');
                    location.reload(); // Перезагрузка страницы для отображения изменений
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${error.detail}`);
                }
            } catch (err) {
                alert(`Произошла ошибка: ${err.message}`);
            }
        }



        async function removeCartItem(productId) {
            try {
                const response = await fetch(`/cart/remove/${productId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    // Удаляем строку из таблицы
                    document.querySelector(`tr[data-product-id="${productId}"]`).remove();

                    // Получаем обновленные данные из ответа
                    const result = await response.json();

                    // Обновляем общую стоимость
                    const totalCostElement = document.getElementById('total-cost');
                    if (totalCostElement) {
                        totalCostElement.textContent = `Общая стоимость: ${result.total_cost} ₽`;
                    }

                    togglePaymentOptions();

                    alert('Товар успешно удален из корзины!');
                } else {
                    const error = await response.json();
                    alert(`Ошибка: ${JSON.stringify(error.detail)}`);
                }
            } catch (err) {
                alert(`Произошла ошибка: ${err.message}`);
            }
        }


        async function submitOrder(isCard) {
            const address = document.getElementById('address').value;
            if (!address) {
                alert('Пожалуйста, введите адрес доставки.');
                return;
            }

            // Пример данных корзины, замените на динамические значения, если требуется
            const cartItems = [
                {% for item in cart_items %}
        {
            product_id: "{{ item.product_id }}",
                quantity: "{{ item.quantity }}",
                    price: "{{ item.price }}"
        },
        {% endfor %}
            ];

        const total = {{ total_cost }};

        try {
            const response = await fetch('/order/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    address: address,
                    is_card: isCard,
                    is_sbp: !isCard,
                    items: cartItems,
                    total: total
                }),
            });

            if (response.ok) {
                const result = await response.json();
                alert(`Заказ создан! ID заказа: ${result.order_id}`);
                window.location.href = result.payment_url; // Переход к оплате
            } else {
                const error = await response.json();
                alert(`Ошибка: ${JSON.stringify(error.detail)}`);
            }
        } catch (err) {
            alert(`Произошла ошибка: ${err.message}`);
        }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>